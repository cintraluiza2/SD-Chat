<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Teste WebSocket Chat-API</title>
  <style>
    /* ======== RESET SUAVE ======== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #eef1f5;
      color: #333;
    }

    /* ======== T√çTULO ======== */
    #app-title {
      text-align: center;
      margin: 20px 0 10px;
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
    }

    /* ======== SE√á√ÉO DE LOGIN / CADASTRO ======== */
    #login-area,
    #register-area {
      background: white;
      max-width: 400px;
      margin: 20px auto;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 4px rgba(74, 144, 226, 0.4);
    }

    button {
      padding: 10px 18px;
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 600;
    }

    button:hover {
      background: #337acc;
    }

    /* ======== TOKEN BOX ======== */
    #token-box {
      max-width: 900px;
      margin: 10px auto;
      background: #dceefd;
      border: 1px solid #9ec7f3;
      color: #1a3b5d;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      word-break: break-all;
    }

    /* ======== LISTA DE CONVERSAS ======== */
    #conversation-area {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    #conversations-list li {
      padding: 8px 12px;
      margin-bottom: 6px;
      background: #f6f7f9;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    #conversations-list li:hover {
      background: #e9eef6;
    }

    /* ======== √ÅREA DO CHAT ======== */
    #chat-area {
      display: none;
      flex-direction: row;
      gap: 30px;
      align-items: flex-start;
      width: 100%;
      max-width: 1000px;
      margin: 25px auto;
    }

    /* Painel principal */
    .chat-panel {
      flex: 3;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Lista de mensagens */
    #chat {
      border: none;
      height: 350px;
      overflow-y: auto;
      margin-bottom: 15px;
      background: #f9f9fb;
      border-radius: 12px;
      padding: 15px;
    }

    #messages {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    /* ======== BAL√ïES DE MENSAGEM ======== */
    #messages li {
      margin-bottom: 12px;
      padding: 8px 12px;
      display: inline-block;
      max-width: 80%;
      border-radius: 12px;
      line-height: 1.4em;
    }

    /* Minhas mensagens */
    .me {
      background: #d1e7ff;
      color: #0e3a5f;
      font-weight: 600;
      align-self: flex-end;
    }

    /* Mensagem de outros */
    .other {
      background: #e2f5e8;
      color: #225b32;
      border: 1px solid #c5e8d0;
    }

    /* Mensagens do sistema */
    .system {
      background: #f0f0f0;
      color: #777;
      font-style: italic;
    }

    /* Input do chat */
    #msg {
      width: 78%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .chat-panel button {
      width: 20%;
    }

    /* ======== PARTICIPANTES ======== */
    .participants-panel {
      flex: 1;
      background: white !important;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      height: 400px;
      overflow-y: auto;
    }

    /* ======== BOT√ÉO VOLTAR ======== */
    #voltar-btn {
      display: none;
      background: #777;
      margin: 10px auto;
      display: block;
    }

    #voltar-btn:hover {
      background: #555;
    }

    /* ======== SCROLLBAR BONITA ======== */
    #chat::-webkit-scrollbar,
    .participants-panel::-webkit-scrollbar {
      width: 8px;
    }

    #chat::-webkit-scrollbar-thumb,
    .participants-panel::-webkit-scrollbar-thumb {
      background: #c7c7c7;
      border-radius: 6px;
    }

    /* ======== RESPONSIVO ======== */
    @media (max-width: 800px) {
      #chat-area {
        flex-direction: column;
      }

      .participants-panel {
        width: 100%;
        height: auto;
      }

      #msg {
        width: 100%;
        margin-bottom: 10px;
      }

      .chat-panel button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <h2 id="app-title">SD-Chat</h2>


  <div id="login-area">
    <h3>Login</h3>
    <input id="username" placeholder="Nome de usu√°rio" />
    <input id="password" type="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <button onclick="showRegister()">Cadastrar</button>
    <div id="login-status"></div>
  </div>
  <div id="register-area" style="display:none;">
    <h3>Cadastro</h3>
    <input id="reg-username" placeholder="Nome de usu√°rio" />
    <input id="reg-password" type="password" placeholder="Senha" />
    <button onclick="register()">Cadastrar</button>
    <button onclick="showLogin()">Voltar</button>
    <div id="register-status"></div>
  </div>
  <div id="token-box"></div>

  <div id="conversation-area" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0;">üí¨ Conversas</h3>
      <button onclick="logout()" style="background: #e74c3c; padding: 8px 12px; font-size: 14px;">üö™ Logout</button>
    </div>
    
    <h3>Criar conversa</h3>
    <input id="participants" placeholder="Participantes (separados por v√≠rgula)" />
    <select id="conv-type">
      <option value="private">Privada</option>
      <option value="group">Grupo</option>
    </select>
    <button onclick="createConversation()">Criar</button>
    <div id="conv-status"></div>
    <hr>
    
    <h3>üë• Usu√°rios Dispon√≠veis</h3>
    <button onclick="loadOnlineUsers()">Atualizar Usu√°rios Online</button>
    <ul id="online-users-list" style="margin-top: 10px;"></ul>
    <hr>
    
    <h3>Minhas conversas</h3>
    <button onclick="loadConversations()" style="margin-bottom: 10px;">Atualizar Conversas</button>
    <ul id="conversations-list"></ul>
  </div>

  <div id="chat-area">
    <div class="chat-panel">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Chat</h3>
        <button onclick="voltarParaConversas()" style="background: #ff6b6b; padding: 8px 15px; font-size: 14px;">‚Üê Voltar para conversas</button>
      </div>
      <div>Conversa ID: <span id="conv-id"></span></div>
      <div id="chat">
        <ul id="messages"></ul>
      </div>
      <input id="msg" placeholder="Digite sua mensagem" />
      <button onclick="sendMessage()">Enviar</button>
    </div>
    <div class="participants-panel">
      <h4>üë• Participantes</h4>
      <ul id="participants-list"></ul>
    </div>
  </div>

  <script>
    let token = null;
    let username = null;
    let conversationId = null;
    let ws = null;
    let presenceInterval = null;
    let heartbeatInterval = null;

    // Notifica presen√ßa ao servidor quando usuario faz login
    function setUserOnline() {
      fetch('http://localhost:3003/api/v1/presence', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ is_online: true })
      })
        .then(res => res.json())
        .then(data => {
          console.log('Status atualizado para ONLINE:', data);
        })
        .catch(err => console.error('Erro ao atualizar presen√ßa:', err));
    }

    // Mant√©m o usu√°rio online com heartbeat a cada 10 segundos
    function startHeartbeat() {
      // Primeiro heartbeat imediato
      setUserOnline();
      
      // Depois a cada 10 segundos
      heartbeatInterval = setInterval(() => {
        if (token && username) {
          setUserOnline();
        }
      }, 10000);
    }

    // Para o heartbeat
    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // Notifica presen√ßa offline quando usuario sai/fecha aba
    function setUserOffline() {
      if (!token || !username) return;
      
      stopHeartbeat();
      
      console.log('Enviando status OFFLINE para:', username);
      
      // Usa fetch com keepalive para garantir envio mesmo ao fechar
      fetch('http://localhost:3003/api/v1/presence', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ is_online: false }),
        keepalive: true
      })
        .then(() => console.log('Status OFFLINE enviado com sucesso'))
        .catch(err => console.error('Erro ao enviar OFFLINE:', err));
      
      // Backup: tamb√©m tenta uma segunda chamada com beacon se dispon√≠vel
      try {
        const form = new FormData();
        form.append('token', token);
        form.append('is_online', 'false');
        navigator.sendBeacon('http://localhost:3003/api/v1/presence-beacon', form);
      } catch (e) {
        console.log('sendBeacon n√£o dispon√≠vel');
      }
    }

    // Listener para quando o usu√°rio fecha/abandona a aba/janela
    window.addEventListener('beforeunload', setUserOffline);
    window.addEventListener('unload', setUserOffline);

    function login() {
      username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) {
        document.getElementById('login-status').innerText = 'Preencha usu√°rio e senha.';
        return;
      }
      fetch('http://localhost:3003/api/v1/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(async res => {
          if (!res.ok) {
            const err = await res.json();
            document.getElementById('login-status').innerText = err.error || 'Erro ao autenticar';
            return null;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          token = data.token;
          document.getElementById('login-status').innerText = 'Autenticado!';
          document.getElementById('login-area').style.display = 'none';
          document.getElementById('conversation-area').style.display = '';
          document.getElementById('register-area').style.display = 'none';
          document.getElementById('app-title').innerText = `üéØ ${username}`;
          const tokenBox = document.getElementById('token-box');
          tokenBox.innerHTML = `<b>Token JWT:</b><br><span>${token}</span>`;
          tokenBox.style.display = 'block';
          
          // Marcar usu√°rio como ONLINE e iniciar heartbeat
          startHeartbeat();
          
          // Carregar conversas e usu√°rios dispon√≠veis
          loadConversations();
          loadOnlineUsers();
          
          // Carregar mensagens pendentes
          loadPendingMessages();
          
          // Atualizar lista de usu√°rios a cada 5 segundos
          clearInterval(presenceInterval);
          presenceInterval = setInterval(() => {
            loadOnlineUsers();
          }, 5000);
        });
    }

    function showRegister() {
      document.getElementById('login-area').style.display = 'none';
      document.getElementById('register-area').style.display = '';
      document.getElementById('register-status').innerText = '';
    }
    function showLogin() {
      document.getElementById('register-area').style.display = 'none';
      document.getElementById('login-area').style.display = '';
      document.getElementById('login-status').innerText = '';
    }
    function register() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      if (!username || !password) {
        document.getElementById('register-status').innerText = 'Preencha usu√°rio e senha.';
        return;
      }
      fetch('http://localhost:3003/api/v1/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(async res => {
          if (!res.ok) {
            const err = await res.json();
            document.getElementById('register-status').innerText = err.error || 'Erro ao cadastrar';
            return null;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          document.getElementById('register-status').innerText = 'Cadastro realizado! Fa√ßa login.';
          // Limpar campos
          document.getElementById('reg-username').value = '';
          document.getElementById('reg-password').value = '';
        });
    }

    function loadConversations() {
      fetch(`http://localhost:3003/api/v1/users/${username}/conversations`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => res.json())
        .then(data => {
          const ul = document.getElementById('conversations-list');
          ul.innerHTML = '';
          (data.conversations || []).forEach(conv => {
            const li = document.createElement('li');
            li.innerHTML = `<b>${conv.type === 'group' ? 'üë• Grupo' : 'üí¨ Privada'}</b> - ID: ${conv.id}`;
            li.style.cursor = 'pointer';
            li.style.padding = '10px';
            li.style.margin = '8px 0';
            li.style.background = '#e8f4f8';
            li.style.borderRadius = '6px';
            li.style.transition = '0.2s';
            li.onmouseover = () => li.style.background = '#d0e8f2';
            li.onmouseout = () => li.style.background = '#e8f4f8';
            li.onclick = () => selectConversation(conv.id);
            ul.appendChild(li);
          });
        })
        .catch(err => console.error('Erro ao carregar conversas:', err));
    }

    function loadOnlineUsers() {
      if (!token) {
        console.error('Token n√£o dispon√≠vel');
        const ul = document.getElementById('online-users-list');
        ul.innerHTML = '<li style="color: red;">‚ùå Fa√ßa login primeiro</li>';
        return;
      }

      console.log('Carregando usu√°rios online...');
      fetch(`http://localhost:3003/api/v1/users`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => {
          console.log('Response status:', res.status);
          if (!res.ok) {
            return res.json().then(err => {
              throw new Error(`HTTP ${res.status}: ${err.error || res.statusText}`);
            });
          }
          return res.json();
        })
        .then(data => {
          console.log('Dados recebidos:', data);
          const ul = document.getElementById('online-users-list');
          ul.innerHTML = '';
          const users = data.users || [];
          
          console.log('Total de usu√°rios:', users.length);
          
          if (users.length === 0) {
            ul.innerHTML = '<li style="color: #999;">Nenhum usu√°rio dispon√≠vel</li>';
            return;
          }
          
          users.forEach(user => {
            if (user.username === username) {
              console.log('Pulando usu√°rio atual:', user.username);
              return; // N√£o mostra a si mesmo
            }
            
            const status = user.is_online ? 'üü¢' : 'üî¥';
            const statusText = user.is_online ? 'Online' : 'Offline';
            
            const li = document.createElement('li');
            li.innerHTML = `${status} ${user.username}`;
            li.style.cursor = 'pointer';
            li.style.padding = '10px';
            li.style.margin = '8px 0';
            li.style.background = user.is_online ? '#d4edda' : '#f8d7da';
            li.style.borderRadius = '6px';
            li.style.transition = '0.2s';
            li.onmouseover = () => li.style.background = user.is_online ? '#c3e6cb' : '#f5c6cb';
            li.onmouseout = () => li.style.background = user.is_online ? '#d4edda' : '#f8d7da';
            li.style.opacity = user.is_online ? '1' : '0.7';
            
            // Permite clicar mesmo que esteja offline - as mensagens ser√£o salvas como pendentes
            li.onclick = () => startPrivateChat(user.username);
            
            const tooltip = document.createElement('small');
            tooltip.style.display = 'block';
            tooltip.style.fontSize = '12px';
            tooltip.style.color = '#666';
            tooltip.style.marginTop = '3px';
            tooltip.innerText = user.is_online ? 'Clique para iniciar conversa' : 'Clique para enviar mensagem (ser√° entregue ao fazer login)';
            li.appendChild(tooltip);
            
            ul.appendChild(li);
          });
          
          console.log('Usu√°rios carregados com sucesso');
        })
        .catch(err => {
          console.error('Erro ao carregar usu√°rios:', err);
          const ul = document.getElementById('online-users-list');
          ul.innerHTML = `<li style="color: red;">‚ùå ${err.message}</li>`;
        });
    }

    function startPrivateChat(otherUser) {
      const participants = [username, otherUser];
      fetch('http://localhost:3003/api/v1/conversations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ participants, type: 'private' })
      })
        .then(res => res.json())
        .then(data => {
          conversationId = data.conversationId;
          document.getElementById('conv-id').innerText = conversationId;
          document.getElementById('conversation-area').style.display = 'none';
          document.getElementById('chat-area').style.display = 'flex';
          connectWS();
          loadMessages();
          loadParticipants();
          // Mostra mensagem informando se o usu√°rio est√° offline
          const onlineStatus = document.querySelector(`[data-user="${otherUser}"]`);
          if (onlineStatus && !onlineStatus.textContent.includes('üü¢')) {
            addSystemMsg(`‚ö†Ô∏è ${otherUser} est√° offline. Suas mensagens ser√£o entregues quando fizer login.`);
          }
        })
        .catch(err => {
          console.error('Erro ao criar conversa:', err);
          alert('Erro ao abrir conversa: ' + err.message);
        });
    }

    function selectConversation(id) {
      conversationId = id;
      document.getElementById('conv-id').innerText = conversationId;
      document.getElementById('conversation-area').style.display = 'none';
      document.getElementById('chat-area').style.display = 'flex';
      connectWS();
      loadMessages();
      loadParticipants();
    }

    // Fun√ß√£o para voltar para a lista de conversas
    function voltarParaConversas() {
      // Fecha WebSocket
      if (ws) {
        ws.close();
        ws = null;
      }
      
      conversationId = null;
      document.getElementById('messages').innerHTML = '';
      document.getElementById('participants-list').innerHTML = '';
      document.getElementById('msg').value = '';
      
      document.getElementById('chat-area').style.display = 'none';
      document.getElementById('conversation-area').style.display = '';
      
      loadConversations();
      loadOnlineUsers();
    }

    // Carrega mensagens pendentes que chegaram enquanto estava offline
    function loadPendingMessages() {
      if (!token) return;
      
      fetch('http://localhost:3003/api/v1/pending-messages', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => res.json())
        .then(data => {
          const pendingMessages = data.pendingMessages || [];
          
          if (pendingMessages.length === 0) {
            console.log('Nenhuma mensagem pendente');
            return;
          }
          
          console.log(`${pendingMessages.length} mensagens pendentes recebidas`);
          
          // Agrupa mensagens por conversation_id
          const messagesByConv = {};
          pendingMessages.forEach(msg => {
            if (!messagesByConv[msg.conversation_id]) {
              messagesByConv[msg.conversation_id] = [];
            }
            messagesByConv[msg.conversation_id].push(msg);
          });
          
          // Mostra notifica√ß√£o
          let notificationText = `üì¨ Voc√™ tem ${pendingMessages.length} mensagem(ns) pendente(s):\n\n`;
          Object.keys(messagesByConv).forEach(convId => {
            const msgs = messagesByConv[convId];
            const senders = [...new Set(msgs.map(m => m.sender_username))].join(', ');
            notificationText += `‚Ä¢ Conversa ${convId}: ${msgs.length} msg(ns) de ${senders}\n`;
          });
          
          alert(notificationText);
          
          // Recarrega as conversas para atualizar as mensagens
          loadConversations();
        })
        .catch(err => console.error('Erro ao carregar mensagens pendentes:', err));
    }

    // Fun√ß√£o para fazer logout (sair da aplica√ß√£o)
    function logout() {
      // Marcar como offline
      setUserOffline();
      
      // Limpar dados
      clearInterval(presenceInterval);
      stopHeartbeat();
      token = null;
      username = null;
      conversationId = null;
      if (ws) {
        ws.close();
        ws = null;
      }
      
      // Limpar interface
      document.getElementById('login-area').style.display = '';
      document.getElementById('conversation-area').style.display = 'none';
      document.getElementById('chat-area').style.display = 'none';
      document.getElementById('register-area').style.display = 'none';
      document.getElementById('app-title').innerText = 'üéØ Chat';
      document.getElementById('login-status').innerText = '';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('token-box').style.display = 'none';
      document.getElementById('token-box').innerHTML = '';
      
      alert('Logout realizado! Voc√™ foi marcado como offline.');
    }

    function createConversation() {
      const participants = document.getElementById('participants').value.split(',').map(s => s.trim()).filter(Boolean);
      if (!participants.includes(username)) participants.push(username);
      const type = document.getElementById('conv-type').value;
      fetch('http://localhost:3003/api/v1/conversations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ participants, type })
      })
        .then(res => res.json())
        .then(data => {
          conversationId = data.conversationId;
          document.getElementById('conv-status').innerText = 'Conversa criada!';
          document.getElementById('conversation-area').style.display = 'none';
          document.getElementById('chat-area').style.display = 'flex';
          document.getElementById('conv-id').innerText = conversationId;
          connectWS();
          loadMessages();
          loadParticipants();
          loadConversations(); // Atualiza lista ap√≥s criar
        });
    }
    function loadParticipants() {
      fetch(`http://localhost:3003/api/v1/conversations/${conversationId}/participants`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => res.json())
        .then(data => {
          const users = data.participants || [];
          const ul = document.getElementById('participants-list');
          ul.innerHTML = '';
          users.forEach(user => {
            const li = document.createElement('li');
            li.innerText = user;
            ul.appendChild(li);
          });
        });
    }

    function loadMessages() {
      fetch(`http://localhost:3003/api/v1/conversations/${conversationId}/messages`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => res.json())
        .then(data => {
          const messages = data.messages || [];
          const ul = document.getElementById('messages');
          ul.innerHTML = '';
          messages.forEach(msg => {
            const li = document.createElement('li');
            li.className = msg.sender_username === username ? 'me' : 'other';
            li.innerText = `${msg.sender_username}: ${msg.content}`;
            ul.appendChild(li);
          });
        });
    }

    function sendMessage() {
      const content = document.getElementById('msg').value;
      if (!content) return;
      fetch('http://localhost:3003/api/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ conversationId, content })
      })
        .then(() => {
          addMsg(username, content); // mostra imediatamente
          document.getElementById('msg').value = '';
          loadConversations(); // Atualiza lista ao enviar mensagem
        });
    }

    function connectWS() {
      ws = new WebSocket('ws://localhost:3003/?token=' + token);
      ws.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.type === 'welcome') {
          addSystemMsg('Conectado como ' + data.user);
        }
        if (data.type === 'new_message' && data.message.conversation_id == conversationId) {
          addMsg(data.message.sender_username, data.message.content);
        }
      };
      ws.onclose = function () {
        addSystemMsg('WebSocket desconectado');
      };
    }

    function addMsg(user, content) {
      const ul = document.getElementById('messages');
      const li = document.createElement('li');
      li.className = user === username ? 'me' : 'other';
      li.innerText = `${user}: ${content}`;
      ul.appendChild(li);
    }

    function addSystemMsg(msg) {
      const ul = document.getElementById('messages');
      const li = document.createElement('li');
      li.className = 'system';
      li.innerText = msg;
      ul.appendChild(li);
    }
  </script>



</body>

</html>